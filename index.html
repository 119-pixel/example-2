<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI è¦–è¦ºåŠ©æ‰‹ (ç›¸æ©Ÿç‰ˆ)</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            color: #333;
        }

        .container {
            width: 100%;
            max-width: 480px; /* æ‰‹æ©Ÿé©é…å¯¬åº¦ */
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* å¡ç‰‡é€šç”¨æ¨£å¼ */
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-header.blue { background-color: #007aff; color: white; }
        .card-header.dark { background-color: #333; color: white; }

        /* --- èŠå¤©å€ --- */
        .chat-area {
            height: 200px;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .msg {
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 0.95rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        .msg.bot { background: #e9e9eb; color: #000; align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg.user { background: #007aff; color: white; align-self: flex-end; border-bottom-right-radius: 4px; }

        /* --- ç›¸æ©Ÿä»‹é¢å€ --- */
        .camera-viewport {
            position: relative;
            width: 100%;
            height: 350px; /* è§€æ™¯çª—é«˜åº¦ */
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* å½±ç‰‡èˆ‡ Canvas é‡ç–Š */
        video, canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* å¡«æ»¿ç•«é¢ */
        }

        /* é è¨­éš±è— Canvas (æˆªåœ–ç”¨) */
        #snapshot-canvas {
            display: none;
            cursor: crosshair;
        }

        /* ç›¸æ©Ÿæ§åˆ¶åˆ— */
        .camera-controls {
            padding: 15px;
            display: flex;
            justify-content: space-around;
            background: #fff;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: #007aff; color: white; }
        .btn-danger { background: #ff3b30; color: white; }
        .btn-outline { background: transparent; border: 1px solid #ddd; color: #333; }

        /* çµæœé¡¯ç¤º */
        .result-panel {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f9fa;
        }
        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .color-info {
            flex: 1;
            margin-left: 15px;
            font-family: monospace;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* éŒ¯èª¤æç¤º */
        #error-msg {
            display: none;
            color: white;
            background: rgba(255, 59, 48, 0.9);
            padding: 10px;
            position: absolute;
            z-index: 10;
            text-align: center;
            width: 80%;
            border-radius: 8px;
        }

    </style>
</head>
<body>

<div class="container">

    <div class="card">
        <div class="card-header blue">ğŸ’¬ AI åŠ©æ‰‹</div>
        <div class="chat-area" id="chat-box">
            <div class="msg bot">ä½ å¥½ï¼è«‹é»æ“Šä¸‹æ–¹çš„ã€Œé–‹å•Ÿç›¸æ©Ÿã€æŒ‰éˆ•ã€‚æˆ‘å¯ä»¥å¹«ä½ åˆ†æç•«é¢ä¸­çš„é¡è‰²ã€‚</div>
        </div>
    </div>

    <div class="card">
        <div class="card-header dark">ğŸ“· è¦–è¦ºé¡é ­</div>
        
        <div class="camera-viewport">
            <div id="error-msg"></div>
            <video id="video-feed" autoplay playsinline muted></video>
            <canvas id="snapshot-canvas"></canvas>
        </div>

        <div class="result-panel">
            <div class="color-preview" id="color-box" style="background-color: #fff;"></div>
            <div class="color-info" id="color-text">ç­‰å¾…æˆªå–...</div>
        </div>

        <div class="camera-controls">
            <button class="btn btn-primary" id="btn-start" onclick="startCamera()">é–‹å•Ÿç›¸æ©Ÿ</button>
            <button class="btn btn-danger" id="btn-snap" onclick="takeSnapshot()" disabled>é–å®šç•«é¢</button>
            <button class="btn btn-outline" id="btn-reset" onclick="resetCamera()" style="display:none;">é‡æ‹</button>
        </div>
        
        <div style="padding: 10px; font-size: 12px; color: #888; text-align: center;">
            æ“ä½œï¼šé–‹å•Ÿç›¸æ©Ÿ -> é–å®šç•«é¢ -> é»æ“Šç•«é¢ä»»æ„è™•å–è‰²
        </div>
    </div>

</div>

<script>
    // --- è®Šæ•¸å®£å‘Š ---
    const video = document.getElementById('video-feed');
    const canvas = document.getElementById('snapshot-canvas');
    const ctx = canvas.getContext('2d');
    const btnStart = document.getElementById('btn-start');
    const btnSnap = document.getElementById('btn-snap');
    const btnReset = document.getElementById('btn-reset');
    const errorMsg = document.getElementById('error-msg');
    const colorBox = document.getElementById('color-box');
    const colorText = document.getElementById('color-text');
    
    let stream = null;
    let isSnapshotMode = false;

    // --- ç›¸æ©ŸåŠŸèƒ½ ---

    // 1. å•Ÿå‹•ç›¸æ©Ÿ
    async function startCamera() {
        try {
            // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™ (å„ªå…ˆä½¿ç”¨å¾Œç½®é¡é ­ 'environment')
            const constraints = { 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            };
            
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            
            // æ›´æ–° UI
            btnStart.style.display = 'none';
            btnSnap.disabled = false;
            btnReset.style.display = 'none';
            canvas.style.display = 'none';
            video.style.display = 'block';
            errorMsg.style.display = 'none';
            
            addBotMessage("ç›¸æ©Ÿå·²å•Ÿå‹•ï¼å°æº–ç‰©é«”å¾Œï¼ŒæŒ‰ä¸‹ã€Œé–å®šç•«é¢ã€ä¾†æ•æ‰é¡è‰²ã€‚");

        } catch (err) {
            console.error("ç›¸æ©ŸéŒ¯èª¤:", err);
            showError("ç„¡æ³•é–‹å•Ÿç›¸æ©Ÿã€‚è«‹ç¢ºèªï¼š<br>1. æ‚¨å·²å…è¨±ç›¸æ©Ÿæ¬Šé™<br>2. ç¶²ç«™ä½¿ç”¨ HTTPS (æˆ– Localhost)");
            addBotMessage("å™¢ä¸ï¼Œæˆ‘ç„¡æ³•å­˜å–ç›¸æ©Ÿã€‚å¯èƒ½æ˜¯å› ç‚ºç€è¦½å™¨å®‰å…¨æ€§é™åˆ¶ã€‚");
        }
    }

    // 2. é–å®šç•«é¢ (æˆªåœ–)
    function takeSnapshot() {
        if (!stream) return;

        // è¨­å®š Canvas å¤§å°èˆ‡å½±ç‰‡ä¸€è‡´
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // å°‡ç›®å‰å½±ç‰‡çš„ä¸€å¹€ç•«åˆ° Canvas ä¸Š
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // åˆ‡æ›é¡¯ç¤ºæ¨¡å¼
        video.style.display = 'none';
        canvas.style.display = 'block';
        
        // åœæ­¢å½±ç‰‡ä¸²æµä»¥ç¯€çœè³‡æº (å¯é¸ï¼Œé€™è£¡é¸æ“‡ä¸å®Œå…¨é—œé–‰ä»¥ä¾¿é‡æ‹ï¼Œä½†æš«åœæ’­æ”¾)
        video.pause();

        // æ›´æ–° UI
        btnSnap.style.display = 'none';
        btnReset.style.display = 'flex';
        isSnapshotMode = true;

        addBotMessage("ç•«é¢å·²é–å®šï¼ç¾åœ¨è«‹ç”¨æ‰‹æŒ‡é»æ“Šåœ–ç‰‡ä¸­çš„ä»»æ„ä½ç½®ä¾†è¾¨è­˜é¡è‰²ã€‚");
    }

    // 3. é‡ç½® (å›åˆ°å³æ™‚é è¦½)
    function resetCamera() {
        video.play();
        video.style.display = 'block';
        canvas.style.display = 'none';
        
        btnSnap.style.display = 'flex';
        btnReset.style.display = 'none';
        isSnapshotMode = false;
        
        colorText.textContent = "ç­‰å¾…æˆªå–...";
        colorBox.style.backgroundColor = "#fff";
    }

    // 4. é»æ“Šåœ–ç‰‡å–è‰²åŠŸèƒ½
    canvas.addEventListener('click', function(event) {
        if (!isSnapshotMode) return;

        // è¨ˆç®—é»æ“Šåº§æ¨™ (è™•ç† CSS ç¸®æ”¾å°è‡´çš„åº§æ¨™åç§»)
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const x = (event.clientX - rect.left) * scaleX;
        const y = (event.clientY - rect.top) * scaleY;

        // è®€å–åƒç´ è³‡æ–™
        const pixel = ctx.getImageData(x, y, 1, 1).data;
        const hex = rgbToHex(pixel[0], pixel[1], pixel[2]);
        const rgbStr = `RGB(${pixel[0]}, ${pixel[1]}, ${pixel[2]})`;

        // é¡¯ç¤ºçµæœ
        updateResult(hex, rgbStr);
    });

    // --- è¼”åŠ©åŠŸèƒ½ ---

    function rgbToHex(r, g, b) {
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
    }

    function updateResult(hex, rgb) {
        colorBox.style.backgroundColor = hex;
        colorText.innerHTML = `${hex}<br><span style="font-size:12px; color:#666">${rgb}</span>`;
        
        // è®“æ©Ÿå™¨äººèªªè©±
        addBotMessage(`åˆ†æå®Œæˆï¼é€™å€‹é¡è‰²æ˜¯ ${hex}ã€‚`);
    }

    function showError(msg) {
        errorMsg.innerHTML = msg;
        errorMsg.style.display = 'block';
    }

    // --- ç°¡å–®çš„èŠå¤©åŠŸèƒ½ ---
    function addBotMessage(text) {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = 'msg bot';
        div.innerHTML = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

</script>

</body>
</html>
